<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Buttons - Phong Thá»§y LÃª Gia</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .log { margin: 5px 0; padding: 5px; background: #f5f5f5; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Tá»± Äá»™ng - Táº¥t Cáº£ NÃºt Báº¥m</h1>
    
    <div class="test-section">
        <h2>ğŸ›ï¸ Äiá»u Khiá»ƒn Test</h2>
        <button onclick="startAutoTest()">ğŸš€ Báº¯t Äáº§u Test Tá»± Äá»™ng</button>
        <button onclick="clearLogs()">ğŸ—‘ï¸ XÃ³a Log</button>
        <button onclick="window.open('http://localhost:3000', '_blank')">ğŸŒ Má»Ÿ á»¨ng Dá»¥ng ChÃ­nh</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Káº¿t Quáº£ Test</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ Chi Tiáº¿t Log</h2>
        <div id="test-logs"></div>
    </div>

    <script>
        const results = document.getElementById('test-results');
        const logs = document.getElementById('test-logs');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            logs.innerHTML = '';
            results.innerHTML = '';
        }

        async function testButton(selector, name, action = 'click') {
            try {
                log(`ğŸ” Testing button: ${name} (${selector})`);
                
                // Má»Ÿ á»©ng dá»¥ng trong iframe áº©n Ä‘á»ƒ test
                const iframe = document.createElement('iframe');
                iframe.src = 'http://localhost:3000';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                return new Promise((resolve) => {
                    iframe.onload = () => {
                        try {
                            const doc = iframe.contentDocument;
                            const button = doc.querySelector(selector);
                            
                            if (!button) {
                                log(`âŒ Button not found: ${name}`, 'error');
                                resolve(false);
                                return;
                            }
                            
                            if (button.disabled) {
                                log(`âš ï¸ Button disabled: ${name}`, 'warning');
                                resolve(false);
                                return;
                            }
                            
                            // Test click event
                            button.click();
                            
                            // Äá»£i 1 giÃ¢y Ä‘á»ƒ xem pháº£n á»©ng
                            setTimeout(() => {
                                log(`âœ… Button clicked successfully: ${name}`, 'success');
                                document.body.removeChild(iframe);
                                resolve(true);
                            }, 1000);
                            
                        } catch (error) {
                            log(`âŒ Error testing ${name}: ${error.message}`, 'error');
                            document.body.removeChild(iframe);
                            resolve(false);
                        }
                    };
                });
                
            } catch (error) {
                log(`âŒ Error setting up test for ${name}: ${error.message}`, 'error');
                return false;
            }
        }

    async function testAPIEndpoint(endpoint, name, method = 'GET', body = null, expectedStatus = 200) {
            try {
                log(`ğŸŒ Testing API: ${name} (${method} ${endpoint})`);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(`http://localhost:3000${endpoint}`, options);
                
                if (response.status === expectedStatus) {
                    log(`âœ… API ${name} tráº£ vá» Ä‘Ãºng tráº¡ng thÃ¡i mong Ä‘á»£i ${expectedStatus}`, 'success');
                    return true;
                } else if (expectedStatus === 410 && response.status === 410) {
                    log(`âœ… ${name}: 410 (disabled)`, 'success');
                    return true;
                } else {
                    log(`âŒ API ${name}: Expected ${expectedStatus} nháº­n ${response.status}`, 'error');
                    return false;
                }
                
            } catch (error) {
                log(`âŒ API error: ${name} - ${error.message}`, 'error');
                return false;
            }
        }

        async function testFileExists(filePath, name) {
            try {
                log(`ğŸ“ Testing file: ${name} (${filePath})`);
                
                const response = await fetch(`http://localhost:3000${filePath}`);
                
                if (response.ok) {
                    log(`âœ… File exists: ${name}`, 'success');
                    return true;
                } else {
                    log(`âŒ File missing: ${name} - Status: ${response.status}`, 'error');
                    return false;
                }
                
            } catch (error) {
                log(`âŒ File test error: ${name} - ${error.message}`, 'error');
                return false;
            }
        }

        async function startAutoTest() {
            clearLogs();
            log('ğŸš€ Báº¯t Ä‘áº§u test tá»± Ä‘á»™ng...', 'info');
            
            const tests = [];
            let passed = 0;
            let failed = 0;

            // Test cÃ¡c file tÄ©nh quan trá»ng
            log('ğŸ“ Testing static files...', 'info');
            tests.push(['style.css', 'CSS File']);
            tests.push(['script.js', 'Main Script']);
            tests.push(['data/wards.json', 'Wards Data']);
            
            for (const [file, name] of tests) {
                const result = await testFileExists(`/${file}`, name);
                if (result) passed++; else failed++;
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Test API endpoints
            log('ğŸŒ Testing API endpoints...', 'info');
            const apiTests = [
                ['/api/auspicious-days?birth=1990-01-01&year=2025&month=8', 'Auspicious Days API', 'GET', null, 200],
                ['/api/chart?name=Test', 'Chart API', 'GET', null, 200],
                ['/health', 'Health Endpoint', 'GET', null, 200]
            ];
            
            for (const def of apiTests) {
                const [endpoint,name,method='GET',body=null,expected=200] = def;
                const result = await testAPIEndpoint(endpoint, name, method, body, expected);
                if (result) passed++; else failed++;
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // (Former AI endpoints removed)

            // Test modules import (kiá»ƒm tra console errors)
            log('ğŸ“¦ Testing module imports...', 'info');
            const moduleTests = [
                'lunar.mjs',
                'siteIssues.mjs', 
                'wards.mjs',
                'parseDateParts.mjs',
                'fortune.mjs'
            ];
            
            for (const module of moduleTests) {
                try {
                    const response = await fetch(`http://localhost:3000/${module}`);
                    if (response.ok) {
                        log(`âœ… Module accessible: ${module}`, 'success');
                        passed++;
                    } else {
                        log(`âŒ Module not accessible: ${module}`, 'error');
                        failed++;
                    }
                } catch (error) {
                    log(`âŒ Module test error: ${module} - ${error.message}`, 'error');
                    failed++;
                }
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            // Kiá»ƒm tra main page load
            log('ğŸ  Testing main page load...', 'info');
            try {
                const response = await fetch('http://localhost:3000');
                if (response.ok) {
                    const html = await response.text();
                    const hasTitle = html.includes('Phong Thá»§y LÃª Gia');
                    const hasAnalyzeButton = html.includes('btn-analyze');
                    const hasIssuesContainer = html.includes('issues-container');
                    const hasWardSelect = html.includes('bd-ward');
                    
                    if (hasTitle && hasAnalyzeButton && hasIssuesContainer && hasWardSelect) {
                        log(`âœ… Main page loaded with all required elements`, 'success');
                        passed++;
                    } else {
                        log(`âš ï¸ Main page missing some elements`, 'warning');
                        log(`  - Title: ${hasTitle}`, hasTitle ? 'success' : 'error');
                        log(`  - Analyze Button: ${hasAnalyzeButton}`, hasAnalyzeButton ? 'success' : 'error');
                        log(`  - Issues Container: ${hasIssuesContainer}`, hasIssuesContainer ? 'success' : 'error');
                        log(`  - Ward Select: ${hasWardSelect}`, hasWardSelect ? 'success' : 'error');
                        failed++;
                    }
                } else {
                    log(`âŒ Main page failed to load - Status: ${response.status}`, 'error');
                    failed++;
                }
            } catch (error) {
                log(`âŒ Main page test error: ${error.message}`, 'error');
                failed++;
            }

            // Hiá»ƒn thá»‹ káº¿t quáº£ tá»•ng há»£p
            const total = passed + failed;
            const percentage = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            
            results.innerHTML = `
                <h3>ğŸ“Š Káº¿t Quáº£ Test Tá»•ng Há»£p</h3>
                <div style="font-size: 18px; margin: 10px 0;">
                    <div class="success">âœ… Passed: ${passed}</div>
                    <div class="error">âŒ Failed: ${failed}</div>
                    <div><strong>ğŸ“ˆ Success Rate: ${percentage}%</strong></div>
                </div>
                
                <h4>ğŸ”§ Khuyáº¿n nghá»‹:</h4>
                <ul>
                    ${failed === 0 ? 
                        '<li class="success">ğŸ‰ Táº¥t cáº£ test Ä‘á»u passed! á»¨ng dá»¥ng hoáº¡t Ä‘á»™ng tá»‘t.</li>' :
                        `<li class="warning">âš ï¸ CÃ³ ${failed} test failed. HÃ£y kiá»ƒm tra log chi tiáº¿t á»Ÿ trÃªn.</li>`
                    }
                    <li>ğŸ“± HÃ£y test thá»§ cÃ´ng cÃ¡c nÃºt báº¥m trÃªn giao diá»‡n chÃ­nh.</li>
                    <li>ğŸ”„ Reload láº¡i trang náº¿u cÃ³ lá»—i cache.</li>
                    <li>ğŸ—‚ï¸ Kiá»ƒm tra táº¥t cáº£ dá»¯ liá»‡u file cÃ³ Ä‘áº§y Ä‘á»§ khÃ´ng.</li>
                </ul>
            `;

            log(`ğŸ Test hoÃ n thÃ nh! Passed: ${passed}/${total} (${percentage}%)`, 
                 percentage >= 80 ? 'success' : percentage >= 60 ? 'warning' : 'error');
        }
    </script>
</body>
</html>
